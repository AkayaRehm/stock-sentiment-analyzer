<script>
  async function analyzeTicker() {
    const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
    if (!ticker) return alert("Please enter a ticker symbol.");

    document.getElementById('result').classList.remove('hidden');
    document.getElementById('tickerSymbol').innerText = ticker;
    document.getElementById('premarketData').innerText = 'Loading...';
    document.getElementById('newsList').innerHTML = '';
    document.getElementById('socialSentiment').innerText = 'Loading...';
    document.getElementById('confidenceBadge').innerHTML = '';

    try {
      const apiKey = 'FxKxKNphzgp1LPElyEW1v2d2p3m_c0Lg';
      const url = `https://api.polygon.io/v2/aggs/ticker/${ticker}/prev?adjusted=true&apiKey=${apiKey}`;
      const response = await fetch(url);
      const data = await response.json();

      if (!data || !data.results || !data.results[0]) throw new Error("No premarket data available.");

      const result = data.results[0];
      const close = result.c;
      const volume = result.v;
      const open = result.o;

      const change = close - open;
      const percentChange = ((change / open) * 100).toFixed(2);

      const summary = `${ticker} is ${change >= 0 ? 'up' : 'down'} ${percentChange}% with volume: ${volume.toLocaleString()}`;
      document.getElementById('premarketData').innerText = summary;

      // Safe fixed badge class logic
      let confidence = '';
      let badgeClass = '';
      if (percentChange >= 5) {
        confidence = 'High Confidence Play';
        badgeClass = 'bg-green-500';
      } else if (percentChange >= 2) {
        confidence = 'Watchlist';
        badgeClass = 'bg-yellow-500';
      } else {
        confidence = 'Avoid Today';
        badgeClass = 'bg-red-500';
      }

      document.getElementById('confidenceBadge').innerHTML =
        `<span class="${badgeClass} text-white px-3 py-1 rounded-full">${confidence}</span>`;
    } catch (err) {
      console.error('[Polygon API Error]', err);
      document.getElementById('premarketData').innerText = 'Failed to fetch premarket data.';
    }

    document.getElementById('newsList').innerHTML = `<li>Live news coming next step...</li>`;
    document.getElementById('socialSentiment').innerText = `Reddit/Twitter analysis coming soon.`;
  }
</script>

